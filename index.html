<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–õ–µ—Å–æ–ø–∞—Ä–∫</title>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            font-size: 12px;
            max-width: 320px;
        }
        #panorama-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 15px rgba(0,0,0,0.9), 0 0 30px rgba(0,0,0,0.7), 0 0 45px rgba(0,0,0,0.5);
            z-index: 200;
            white-space: nowrap;
            pointer-events: none;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–∞—Ä–∫–µ—Ä–∞ ‚Äì –≤—Å—ë –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–≥–æ */
        .marker-container {
            position: absolute;
            left: 0;
            top: 0;
            pointer-events: auto;
            z-index: 101;
            opacity: 0.7;
            transition: opacity 0.2s ease;
            --pole-height: 2.5em; /* –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
        .marker-container:hover {
            opacity: 1;
        }

        /* –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ (—Ç–µ–∫—Å—Ç) ‚Äì –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω –ª–µ–≤—ã–º –Ω–∏–∂–Ω–∏–º —É–≥–ª–æ–º –∫ –≤–µ—Ä—Ö–Ω–µ–º—É –∫–æ–Ω—Ü—É –¥—Ä–µ–≤–∫–∞ */
        .marker-rect {
            position: absolute;
            left: calc(-3px);
            bottom: calc(var(--pole-height) - 4px); /* –Ω–∞–µ–∑–¥ 4px –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è —â–µ–ª–∏ */
            
            background: var(--marker-color, #ffffff);
            padding: 0.75em 1.2em;
            white-space: pre !important;
            overflow-wrap: normal !important;
            word-break: normal !important;
            word-wrap: normal !important;
            max-width: none !important;
            width: auto !important;
            
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            color: #333;
            border: 1px solid rgba(0,0,0,0.1);
            font-size: 14px;
            font-family: Arial, sans-serif;
            cursor: pointer;
            line-height: 1.4;
            text-align: center;
            pointer-events: auto;
        }
        .marker-rect a {
            color: inherit;
            text-decoration: none;
        }
        .marker-rect a:hover {
            text-decoration: underline;
        }

        /* –î—Ä–µ–≤–∫–æ */
        .marker-pole {
            position: absolute;
            left: 0;
            bottom: 0;
            width: 5px;
            height: var(--pole-height);
            background: var(--marker-color, #ffffff);
            border-radius: 3px;
            transform: translateX(-50%);
            pointer-events: none;
            transition: height 0.2s ease;
        }

        /* –¢–æ—á–∫–∞ –∫—Ä–µ–ø–ª–µ–Ω–∏—è */
        .marker-dot {
            position: absolute;
            left: 0;
            top: 0;
            width: 12px;
            height: 12px;
            background: var(--marker-color, #ffffff);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            color: white;
            z-index: 100;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            max-width: 90%;
        }
        button {
            margin: 0 2px;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            font-weight: bold;
            white-space: nowrap;
        }
        button:hover { background: #45a049; }
        button.delete { background: #f44336; }
        button.delete:hover { background: #d32f2f; }
        button.secondary { background: #2196F3; }
        button.secondary:hover { background: #1976D2; }
        #upload-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            z-index: 101;
            text-align: center;
            min-width: 300px;
        }
        #upload-panel h2 { margin-top: 0; }
        #file-input {
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin: 15px 0;
        }
        .hidden { display: none !important; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* –î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ */
        #marker-dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 102;
            min-width: 340px;
            max-width: 500px;
        }
        #marker-dialog h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .dialog-row {
            margin: 10px 0;
        }
        .dialog-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .dialog-row textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
        }
        .dialog-row select,
        .dialog-row input[type="text"],
        .dialog-row input[type="url"],
        .dialog-row input[type="color"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .checkbox-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }
        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .dialog-buttons button {
            padding: 8px 15px;
        }

        /* ===== –î–û–ë–ê–í–õ–ï–ù–û –î–õ–Ø OPERA MOBILE ===== */
        canvas {
            display: block;
            touch-action: none; /* –∑–∞–ø—Ä–µ—â–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∂–µ—Å—Ç—ã */
            -webkit-tap-highlight-color: transparent;
        }

        /* ===== –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–û–î –ú–û–ë–ò–õ–¨–ù–´–ï –£–°–¢–†–û–ô–°–¢–í–ê ===== */
        @media (max-width: 768px) {
            #controls,
            #info {
                display: none !important;
            }
            #panorama-title {
                font-size: 12px;
                top: 5px;
                white-space: normal;
                max-width: 90%;
                text-align: center;
            }
            .marker-rect {
                padding: 0.3em 0.5em;
                font-size: 11px;
            }
            .marker-pole {
                width: 3px;
            }
            .marker-dot {
                width: 8px;
                height: 8px;
            }
            #marker-dialog {
                min-width: 240px;
                max-width: 90%;
                padding: 10px;
            }
            .dialog-row textarea,
            .dialog-row input,
            .dialog-row select {
                font-size: 12px;
            }
        }

        /* –î–ª—è –∞–ª—å–±–æ–º–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        @media (orientation: landscape) and (max-height: 500px) {
            #controls,
            #info {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="panorama-title" class="hidden">–õ–µ—Å–æ–ø–∞—Ä–∫</div>

    <div id="info" class="hidden">
        <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong><br>
        ‚Ä¢ –õ–ö–ú + –¥–≤–∏–≥–∞—Ç—å –º—ã—à—å ‚Äî –≤—Ä–∞—â–∞—Ç—å<br>
        ‚Ä¢ –ö–æ–ª—ë—Å–∏–∫–æ –º—ã—à–∏ ‚Äî –∑—É–º<br>
        ‚Ä¢ –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä<br>
        ‚Ä¢ –ü–ö–ú –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Äî —É–¥–∞–ª–∏—Ç—å (–Ω–∞ –ü–ö)<br>
        ‚Ä¢ üìå –ó–∞–ø–æ–º–Ω–∏—Ç—å –≤–∏–¥ ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ–≤–æ—Ä–æ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ<br>
        ‚Ä¢ ‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥ ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Ü–µ–Ω—Ç—Ä<br>
        ‚Ä¢ üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Äî –∑–∞–ø–∏—Å–∞—Ç—å –º–∞—Ä–∫–µ—Ä—ã –≤ localStorage<br>
        ‚Ä¢ üì• –≠–∫—Å–ø–æ—Ä—Ç JSON ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–∞—Ä–∫–µ—Ä—ã + —Ç–µ–∫—É—â–∏–π –≤–∏–¥ –≤ —Ñ–∞–π–ª<br>
        ‚Ä¢ üì§ –ò–º–ø–æ—Ä—Ç JSON ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–∞—Ä–∫–µ—Ä—ã –∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) –≤–∏–¥ –∏–∑ —Ñ–∞–π–ª–∞<br>
        <strong>–ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ:</strong> –≤—Ä–∞—â–µ–Ω–∏–µ –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º, –∑—É–º –¥–≤—É–º—è.
    </div>
    
    <div id="controls" class="hidden">
        <span>–ú–∞—Ä–∫–µ—Ä–æ–≤: <span id="marker-count">0</span></span>
        <button onclick="saveMarkers()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="clearMarkers()" class="delete">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
        <button onclick="exportMarkers()">üì• –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button onclick="importMarkers()">üì§ –ò–º–ø–æ—Ä—Ç JSON</button>
        <button onclick="saveCurrentView()" class="secondary" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–∏–¥ –≤ localStorage">üìå –ó–∞–ø–æ–º–Ω–∏—Ç—å –≤–∏–¥</button>
        <button onclick="resetView()" class="secondary" title="–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Ü–µ–Ω—Ç—Ä">‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥</button>
        <button onclick="exportView()" class="secondary hidden" title="–≠–∫—Å–ø–æ—Ä—Ç –≤–∏–¥–∞ –≤ —Ñ–∞–π–ª">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤–∏–¥–∞</button>
        <button onclick="importView()" class="secondary hidden" title="–ò–º–ø–æ—Ä—Ç –≤–∏–¥–∞ –∏–∑ —Ñ–∞–π–ª–∞">üì• –ò–º–ø–æ—Ä—Ç –≤–∏–¥–∞</button>
    </div>

    <!-- –î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ -->
    <div id="marker-dialog" class="hidden">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä</h3>
        <div class="dialog-row">
            <label>–¢–µ–∫—Å—Ç (–º–æ–∂–Ω–æ —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫):</label>
            <textarea id="dialog-text" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –º–∞—Ä–∫–µ—Ä–∞..."></textarea>
        </div>
        <div class="dialog-row">
            <label>–¶–≤–µ—Ç —Ñ–ª–∞–∂–∫–∞:</label>
            <input type="color" id="dialog-color" value="#ffffff">
        </div>
        <div class="dialog-row">
            <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞:</label>
            <input type="range" id="dialog-font-size" min="10" max="24" value="14" step="1">
            <span id="dialog-font-size-value">14px</span>
        </div>
        <div class="dialog-row">
            <label>–®—Ä–∏—Ñ—Ç:</label>
            <select id="dialog-font-family">
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="Verdana, sans-serif">Verdana</option>
                <option value="Georgia, serif">Georgia</option>
            </select>
        </div>
        <div class="dialog-row">
            <label>–ù–∞—á–µ—Ä—Ç–∞–Ω–∏–µ:</label>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="dialog-font-bold"> –ñ–∏—Ä–Ω—ã–π
                </label>
                <label>
                    <input type="checkbox" id="dialog-font-italic"> –ö—É—Ä—Å–∏–≤
                </label>
            </div>
        </div>
        <div class="dialog-row">
            <label>–ì–∏–ø–µ—Ä—Å—Å—ã–ª–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="url" id="dialog-url" placeholder="https://example.com">
        </div>
        <div class="dialog-buttons">
            <button onclick="cancelMarkerDialog()" class="delete">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="applyMarkerDialog()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="upload-panel">
        <div id="loading-indicator" class="hidden">
            <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–Ω–æ—Ä–∞–º—ã...</h2>
            <div class="loader"></div>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
        </div>
        <div id="manual-upload">
            <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–∞–Ω–æ—Ä–∞–º—É 360¬∞</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø–∞–Ω–æ—Ä–∞–º—ã (JPG –∏–ª–∏ PNG):</p>
            <input type="file" id="file-input" accept=".jpg,.jpeg,.png,.bmp">
            <p style="font-size: 12px; color: #ccc; margin-top: 20px;">
                –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, CORS –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
            </p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const CONFIG = {
            markersFile: 'markers.json',
            storageKey: 'panorama-markers',
            viewStorageKey: 'panorama-initial-view',
            sphereRadius: 500,
            markerColor: 0xff0000,
            markerSize: 5.0,
            showMarkerDots: false
        };

        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let scene, camera, renderer, sphere;
        let markers = [];
        let markerContainer;
        
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        const rotationSpeed = 0.005;
        
        let sphereRotation = { x: 0, y: 0 };
        
        let velocity = { x: 0, y: 0 };
        let friction = 0.8;
        let isInertia = false;
        
        let fov = 75;
        let minFov = 10;
        let maxFov = 120;
        let targetFov = fov;
        let zoomVelocity = 0;
        let zoomFriction = 0.8;
        
        // –î–ª—è –¥–∏–∞–ª–æ–≥–∞ –º–∞—Ä–∫–µ—Ä–∞
        let pendingMarkerCoords = null;

        // ---- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è touch-—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ----
        let touchStartPositions = [];
        let touchStartDistance = 0;
        let isTouchActive = false;
        let lastTouchPosition = { x: 0, y: 0 };
        let touchVelocity = { x: 0, y: 0 };
        let touchZoomStartFov = fov;

        // ========== –î–ï–¢–ï–ö–¢–û–† OPERA MOBILE ==========
        const isOperaMobile = /opera|opr|opios|opt/i.test(navigator.userAgent) && /mobile/i.test(navigator.userAgent);

        // ========== –§–£–ù–ö–¶–ò–Ø –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –ú–û–ë–ò–õ–¨–ù–û–°–¢–ò ==========
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø THREE.JS ==========
        function initThreeJS() {
            scene = new THREE.Scene();
            
            camera = new THREE.PerspectiveCamera(fov, window.innerWidth / window.innerHeight, 0.1, 3000);
            camera.position.set(0, 0, 0);
            camera.lookAt(0, 0, 0);
            
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                preserveDrawingBuffer: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            markerContainer = document.createElement('div');
            markerContainer.id = 'marker-container';
            document.body.appendChild(markerContainer);
        }

        // ========== –°–û–ó–î–ê–ù–ò–ï –¢–ï–ö–°–¢–£–†–´ ==========
        function createTextureFromImage(img) {
            const texture = new THREE.Texture();
            texture.image = img;
            texture.format = THREE.RGBAFormat;
            texture.generateMipmaps = false;
            texture.minFilter = THREE.LinearFilter;
            texture.magFilter = THREE.LinearFilter;
    
            texture.wrapS = THREE.RepeatWrapping;
            texture.repeat.x = -1;
            texture.offset.x = 1;
            texture.needsUpdate = true;
    
            return texture;
        }

        // ========== –ü–û–ö–ê–ó –ó–ê–ì–û–õ–û–í–ö–ê –ü–ê–ù–û–†–ê–ú–´ ==========
        function showPanoramaTitle() {
            const titleEl = document.getElementById('panorama-title');
            titleEl.textContent = document.title;
            titleEl.classList.remove('hidden');
        }

        // ========== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ü–ê–ù–û–†–ê–ú–´ ==========
        function tryLoadPanorama() {
            return new Promise((resolve, reject) => {
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('manual-upload').classList.add('hidden');
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    console.log('–ü–∞–Ω–æ—Ä–∞–º–∞ panorama.jpg –Ω–∞–π–¥–µ–Ω–∞');
                    const texture = createTextureFromImage(img);
                    const geometry = new THREE.SphereGeometry(CONFIG.sphereRadius, 60, 40);
                    const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.BackSide });
                    sphere = new THREE.Mesh(geometry, material);
                    scene.add(sphere);
                    
                    document.getElementById('upload-panel').classList.add('hidden');
                    document.getElementById('info').classList.remove('hidden');
                    document.getElementById('controls').classList.remove('hidden');
                    showPanoramaTitle();
                    resolve(texture);
                };
                img.onerror = function() {
                    console.log('–ü–∞–Ω–æ—Ä–∞–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∑–∞–≥—Ä—É–∑–∫–∏');
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('manual-upload').classList.remove('hidden');
                    reject(new Error('–ü–∞–Ω–æ—Ä–∞–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'));
                };
                img.src = 'panorama.jpg?' + new Date().getTime();
            });
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –ü–ê–ù–û–†–ê–ú–´ –ò–ó –§–ê–ô–õ–ê ==========
        function loadPanoramaFromFile(file) {
            return new Promise((resolve, reject) => {
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('manual-upload').classList.add('hidden');
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        const texture = createTextureFromImage(img);
                        const geometry = new THREE.SphereGeometry(CONFIG.sphereRadius, 60, 40);
                        const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.BackSide });
                        sphere = new THREE.Mesh(geometry, material);
                        scene.add(sphere);
                        
                        document.getElementById('upload-panel').classList.add('hidden');
                        document.getElementById('info').classList.remove('hidden');
                        document.getElementById('controls').classList.remove('hidden');
                        showPanoramaTitle();
                        resolve(texture);
                    };
                    img.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
                    img.src = event.target.result;
                };
                reader.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'));
                reader.readAsDataURL(file);
            });
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò TOUCH (–î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–•) ==========
        function handleTouchStart(e) {
            e.preventDefault();
            const touches = e.touches;
            if (touches.length === 1) {
                isTouchActive = true;
                isInertia = false;
                lastTouchPosition = { x: touches[0].clientX, y: touches[0].clientY };
                touchVelocity = { x: 0, y: 0 };
            } else if (touches.length === 2) {
                const dx = touches[0].clientX - touches[1].clientX;
                const dy = touches[0].clientY - touches[1].clientY;
                touchStartDistance = Math.sqrt(dx * dx + dy * dy);
                touchZoomStartFov = fov;
                isTouchActive = true;
            }
        }

        function handleTouchMove(e) {
            // FIX FOR OPERA MOBILE: —è–≤–Ω—ã–π preventDefault –Ω–∞ –∫–∞–∂–¥–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏
            e.preventDefault();
            const touches = e.touches;
            if (touches.length === 1 && isTouchActive) {
                const currentPos = { x: touches[0].clientX, y: touches[0].clientY };
                const deltaX = currentPos.x - lastTouchPosition.x;
                const deltaY = currentPos.y - lastTouchPosition.y;
                touchVelocity.x = deltaX * rotationSpeed * 0.5;
                touchVelocity.y = deltaY * rotationSpeed * 0.5;
                sphereRotation.y += deltaX * rotationSpeed;
                sphereRotation.x += deltaY * rotationSpeed;
                sphereRotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, sphereRotation.x));
                if (sphere) {
                    sphere.rotation.y = sphereRotation.y;
                    sphere.rotation.x = sphereRotation.x;
                }
                lastTouchPosition = currentPos;
                // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                updateMarkerLabels();
            } else if (touches.length === 2 && isTouchActive) {
                const dx = touches[0].clientX - touches[1].clientX;
                const dy = touches[0].clientY - touches[1].clientY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const scale = distance / touchStartDistance;
                targetFov = Math.max(minFov, Math.min(maxFov, touchZoomStartFov / scale));
                zoomVelocity = (targetFov - fov) * 0.3;
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            if (e.touches.length === 0) {
                isTouchActive = false;
                // FIX FOR OPERA MOBILE: –æ—Ç–∫–ª—é—á–∞–µ–º –∏–Ω–µ—Ä—Ü–∏—é –¥–ª—è Opera, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                if (isOperaMobile) {
                    isInertia = false;
                    velocity = { x: 0, y: 0 };
                } else {
                    isInertia = true;
                    velocity.x = touchVelocity.x;
                    velocity.y = touchVelocity.y;
                }
            } else if (e.touches.length === 1) {
                lastTouchPosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        }

        // ========== –î–û–õ–ì–û–ï –ù–ê–ñ–ê–¢–ò–ï –î–õ–Ø –£–î–ê–õ–ï–ù–ò–Ø –ú–ê–†–ö–ï–†–ê (–¢–û–õ–¨–ö–û –î–ï–°–ö–¢–û–ü) ==========
        function attachLongPressHandler(element, callback) {
            let timer = null;
            const start = (e) => {
                timer = setTimeout(() => {
                    e.preventDefault();
                    e.stopPropagation();
                    callback(e);
                    timer = null;
                }, 500);
            };
            const cancel = () => {
                if (timer) {
                    clearTimeout(timer);
                    timer = null;
                }
            };
            element.addEventListener('touchstart', start, { passive: true });
            element.addEventListener('touchend', cancel);
            element.addEventListener('touchmove', cancel);
            element.addEventListener('touchcancel', cancel);
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–û–ô (–ú–´–®–¨ + TOUCH) ==========
        function initControls() {
            // –ú—ã—à–∏–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
            renderer.domElement.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    isDragging = true;
                    isInertia = false;
                    velocity = { x: 0, y: 0 };
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                    e.preventDefault();
                }
            });
            renderer.domElement.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                velocity.x = deltaX * rotationSpeed * 0.5;
                velocity.y = deltaY * rotationSpeed * 0.5;
                sphereRotation.y += deltaX * rotationSpeed;
                sphereRotation.x += deltaY * rotationSpeed;
                sphereRotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, sphereRotation.x));
                if (sphere) {
                    sphere.rotation.y = sphereRotation.y;
                    sphere.rotation.x = sphereRotation.x;
                }
                previousMousePosition = { x: e.clientX, y: e.clientY };
                updateMarkerLabels(); // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
            });
            document.addEventListener('mouseup', (e) => {
                if (e.button === 0) {
                    isDragging = false;
                    isInertia = true;
                }
            });
            renderer.domElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomStep = 10;
                if (e.deltaY < 0) targetFov = Math.max(minFov, fov - zoomStep);
                else targetFov = Math.min(maxFov, fov + zoomStep);
                zoomVelocity = (targetFov - fov) * 0.3;
            });

            // Touch —Å–æ–±—ã—Ç–∏—è
            renderer.domElement.addEventListener('touchstart', handleTouchStart, { passive: false });
            renderer.domElement.addEventListener('touchmove', handleTouchMove, { passive: false });
            renderer.domElement.addEventListener('touchend', handleTouchEnd);
            renderer.domElement.addEventListener('touchcancel', handleTouchEnd);
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –í–ò–î–û–ú ==========
        function saveCurrentView() {
            if (!sphere) { alert('–ü–∞–Ω–æ—Ä–∞–º–∞ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞'); return; }
            const viewData = { x: sphereRotation.x, y: sphereRotation.y };
            localStorage.setItem(CONFIG.viewStorageKey, JSON.stringify(viewData));
            alert('–¢–µ–∫—É—â–∏–π –≤–∏–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
        }

        function loadInitialView() {
            const saved = localStorage.getItem(CONFIG.viewStorageKey);
            if (saved) {
                try {
                    const viewData = JSON.parse(saved);
                    sphereRotation.x = viewData.x || 0;
                    sphereRotation.y = viewData.y || 0;
                    sphereRotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, sphereRotation.x));
                    if (sphere) {
                        sphere.rotation.y = sphereRotation.y;
                        sphere.rotation.x = sphereRotation.x;
                    }
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω –Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∏–¥');
                } catch (e) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∞:', e); }
            }
        }

        function resetView() {
            if (!sphere) return;
            sphereRotation = { x: 0, y: 0 };
            sphere.rotation.y = 0;
            sphere.rotation.x = 0;
            velocity = { x: 0, y: 0 };
            isInertia = false;
            console.log('–í–∏–¥ —Å–±—Ä–æ—à–µ–Ω –≤ —Ü–µ–Ω—Ç—Ä');
        }

        function exportView() {
            if (!sphere) { alert('–ü–∞–Ω–æ—Ä–∞–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞'); return; }
            const viewData = { x: sphereRotation.x, y: sphereRotation.y };
            const dataStr = JSON.stringify(viewData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'view.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importView() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const viewData = JSON.parse(event.target.result);
                        if (typeof viewData.x === 'number' && typeof viewData.y === 'number') {
                            sphereRotation.x = viewData.x;
                            sphereRotation.y = viewData.y;
                            sphereRotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, sphereRotation.x));
                            if (sphere) {
                                sphere.rotation.y = sphereRotation.y;
                                sphere.rotation.x = sphereRotation.x;
                            }
                            localStorage.setItem(CONFIG.viewStorageKey, JSON.stringify(viewData));
                            alert('–í–∏–¥ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ —Ñ–∞–π–ª–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ –Ω–∞—á–∞–ª—å–Ω—ã–π');
                        } else {
                            alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –≤–∏–¥–∞');
                        }
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ========== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –í–´–°–û–¢–´ –î–†–ï–í–ö–ê ==========
        function updatePoleHeight(marker) {
            // –î–∞–µ–º –≤—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä—É –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç
            setTimeout(() => {
                if (!marker || !marker.rect || !marker.container) return;
                
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –≤—ã—Å–æ—Ç—É —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
                const rectHeight = marker.rect.offsetHeight;
                
                // –ë–∞–∑–æ–≤–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞
                const minPoleHeight = 30; // –≤ –ø–∏–∫—Å–µ–ª—è—Ö
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥—Ä–µ–≤–∫–∞
                const poleHeight = Math.max(minPoleHeight, rectHeight * 0.8);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                marker.container.style.setProperty('--pole-height', poleHeight + 'px');
                
                // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ç–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–ª–∞–π–Ω-—Å—Ç–∏–ª—å
                if (marker.pole) {
                    marker.pole.style.height = poleHeight + 'px';
                }
            }, 10);
        }

        // ========== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –í–°–ï–• –î–†–ï–í–ö–û–í ==========
        function updateAllPoleHeights() {
            markers.forEach(marker => updatePoleHeight(marker));
        }

        // ========== –ú–ê–†–ö–ï–†–´ ==========
        function addMarker(coords, label = '–ù–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä', id = Date.now().toString(), 
                          fontSize = 14, fontFamily = 'Arial, sans-serif', 
                          fontWeight = 'normal', fontStyle = 'normal', url = '', color = '#ffffff') {
            
            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–∞—Ä–∫–µ—Ä–∞
            let container = document.createElement('div');
            container.className = 'marker-container';
            container.dataset.markerId = id;
            container.style.setProperty('--marker-color', color);
            
            // –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —Å —Ç–µ–∫—Å—Ç–æ–º
            let rect;
            if (url && url.trim() !== '') {
                rect = document.createElement('a');
                rect.href = url;
                rect.target = '_blank';
                rect.rel = 'noopener noreferrer';
            } else {
                rect = document.createElement('div');
            }
            rect.className = 'marker-rect';
            rect.textContent = label;
            rect.style.fontSize = fontSize + 'px';
            rect.style.fontFamily = fontFamily;
            rect.style.fontWeight = fontWeight;
            rect.style.fontStyle = fontStyle;
            
            // –î—Ä–µ–≤–∫–æ
            let pole = document.createElement('div');
            pole.className = 'marker-pole';
            
            // –¢–æ—á–∫–∞
            let dot = document.createElement('div');
            dot.className = 'marker-dot';
            
            container.appendChild(rect);
            container.appendChild(pole);
            container.appendChild(dot);
            
            // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
            const deleteCallback = () => {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ä–∫–µ—Ä?')) {
                    removeMarker(id);
                    saveMarkers();
                }
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º—ã—à–∏ (–ü–ö–ú)
            container.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                deleteCallback();
                return false;
            });
            rect.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                deleteCallback();
                return false;
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö ‚Äî –ø–æ–¥–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            if (!isMobile()) {
                attachLongPressHandler(container, deleteCallback);
                attachLongPressHandler(rect, deleteCallback);
            }

            // –ù–∞–≤–µ–¥–µ–Ω–∏–µ (–º—ã—à—å)
            container.addEventListener('mouseenter', function() {
                container.style.opacity = '1';
            });
            container.addEventListener('mouseleave', function() {
                container.style.opacity = '0.7';
            });
            
            markerContainer.appendChild(container);
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –º–∞—Ä–∫–µ—Ä–∞
            const marker = {
                id, 
                container: container,
                rect: rect,
                pole: pole,
                coords, 
                text: label,
                fontSize, fontFamily, fontWeight, fontStyle, url, color,
                date: new Date().toISOString()
            };
            
            markers.push(marker);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –¥—Ä–µ–≤–∫–∞
            updatePoleHeight(marker);
            
            updateMarkerCount();
            updateMarkerLabels();
            return id;
        }

        function removeMarker(id) {
            const index = markers.findIndex(m => m.id === id);
            if (index !== -1) {
                if (markers[index].container.parentNode) {
                    markerContainer.removeChild(markers[index].container);
                }
                markers.splice(index, 1);
                updateMarkerCount();
                return true;
            }
            return false;
        }

        function getSphericalCoords(event) {
            const mouse = new THREE.Vector2();
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            if (!sphere) return null;
            const tempSphere = new THREE.Sphere(new THREE.Vector3(0,0,0), CONFIG.sphereRadius);
            const intersection = raycaster.ray.intersectSphere(tempSphere, new THREE.Vector3());
            if (intersection) {
                const intersectionPoint = intersection.clone();
                const quaternion = new THREE.Quaternion();
                // FIX FOR OPERA MOBILE: –∏—Å–ø–æ–ª—å–∑—É–µ–º sphere.rotation –≤–º–µ—Å—Ç–æ sphereRotation –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                quaternion.setFromEuler(sphere.rotation);
                intersectionPoint.applyQuaternion(quaternion.inverse());
                const spherical = new THREE.Spherical();
                spherical.setFromVector3(intersectionPoint);
                return spherical;
            }
            return null;
        }

        function updateMarkerLabels() {
            markers.forEach(marker => {
                const position = new THREE.Vector3();
                position.setFromSphericalCoords(CONFIG.sphereRadius, marker.coords.phi, marker.coords.theta);
                const quaternion = new THREE.Quaternion();
                quaternion.setFromEuler(sphere.rotation); // –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç —Å—Ñ–µ—Ä—ã
                const rotatedPosition = position.clone().applyQuaternion(quaternion);
                const vector = rotatedPosition.clone().project(camera);
                
                if (vector.z < 1) {
                    const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                    const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
                    
                    marker.container.style.display = 'block';
                    marker.container.style.left = `${x}px`;
                    marker.container.style.top = `${y}px`;
                    
                    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –¥—Ä–µ–≤–∫–∞ (1% –∫–∞–¥—Ä–æ–≤)
                    if (Math.random() < 0.01) {
                        updatePoleHeight(marker);
                    }
                } else {
                    marker.container.style.display = 'none';
                }
            });
        }

        function updateMarkerCount() {
            document.getElementById('marker-count').textContent = markers.length;
        }

        // ========== –î–ò–ê–õ–û–ì –°–û–ó–î–ê–ù–ò–Ø –ú–ê–†–ö–ï–†–ê ==========
        function showMarkerDialog(initialText = '', initialColor = '#ffffff') {
            document.getElementById('dialog-text').value = initialText;
            document.getElementById('dialog-color').value = initialColor;
            
            const fontSizeSlider = document.getElementById('dialog-font-size');
            const fontSizeValue = document.getElementById('dialog-font-size-value');
            fontSizeSlider.value = '14';
            fontSizeValue.textContent = '14px';
            fontSizeSlider.oninput = (e) => fontSizeValue.textContent = e.target.value + 'px';
            
            document.getElementById('dialog-url').value = '';
            document.getElementById('dialog-font-bold').checked = false;
            document.getElementById('dialog-font-italic').checked = false;
            
            document.getElementById('marker-dialog').classList.remove('hidden');
        }

        function cancelMarkerDialog() {
            document.getElementById('marker-dialog').classList.add('hidden');
            pendingMarkerCoords = null;
        }

        function applyMarkerDialog() {
            const text = document.getElementById('dialog-text').value.trim();
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –º–∞—Ä–∫–µ—Ä–∞');
                return;
            }
            const color = document.getElementById('dialog-color').value;
            const fontSize = document.getElementById('dialog-font-size').value;
            const fontFamily = document.getElementById('dialog-font-family').value;
            const isBold = document.getElementById('dialog-font-bold').checked;
            const isItalic = document.getElementById('dialog-font-italic').checked;
            const url = document.getElementById('dialog-url').value.trim();
            const fontWeight = isBold ? 'bold' : 'normal';
            const fontStyle = isItalic ? 'italic' : 'normal';
            
            document.getElementById('marker-dialog').classList.add('hidden');
            
            if (pendingMarkerCoords) {
                addMarker(pendingMarkerCoords, text, undefined, 
                         parseInt(fontSize), fontFamily, fontWeight, fontStyle, url, color);
                saveMarkers();
                pendingMarkerCoords = null;
            }
        }

        // ========== –°–û–•–†–ê–ù–ï–ù–ò–ï / –ó–ê–ì–†–£–ó–ö–ê –ú–ê–†–ö–ï–†–û–í ==========
        function saveMarkers() {
            const markersData = markers.map(m => ({
                id: m.id, theta: m.coords.theta, phi: m.coords.phi, text: m.text,
                fontSize: m.fontSize, fontFamily: m.fontFamily, fontWeight: m.fontWeight, fontStyle: m.fontStyle,
                url: m.url || '', color: m.color || '#ffffff', date: m.date
            }));
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(markersData));
            alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${markers.length} –º–∞—Ä–∫–µ—Ä–æ–≤ –≤ localStorage`);
        }

        function loadMarkers() {
            fetch(CONFIG.markersFile)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    let markersData = [];
                    let viewData = null;

                    if (Array.isArray(data)) {
                        markersData = data;
                    } else if (data && typeof data === 'object') {
                        if (Array.isArray(data.markers)) markersData = data.markers;
                        if (data.view && typeof data.view.x === 'number' && typeof data.view.y === 'number') {
                            viewData = data.view;
                        }
                    }

                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                    markers.forEach(m => {
                        if (m.container.parentNode) markerContainer.removeChild(m.container);
                    });
                    markers = [];

                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
                    markersData.forEach(markerData => {
                        addMarker(
                            { theta: markerData.theta, phi: markerData.phi },
                            markerData.text,
                            markerData.id,
                            markerData.fontSize || 14,
                            markerData.fontFamily || 'Arial, sans-serif',
                            markerData.fontWeight || 'normal',
                            markerData.fontStyle || 'normal',
                            markerData.url || '',
                            markerData.color || '#ffffff'
                        );
                    });

                    if (viewData) {
                        sphereRotation.x = viewData.x;
                        sphereRotation.y = viewData.y;
                        sphereRotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, sphereRotation.x));
                        if (sphere) {
                            sphere.rotation.y = sphereRotation.y;
                            sphere.rotation.x = sphereRotation.x;
                        }
                        localStorage.setItem(CONFIG.viewStorageKey, JSON.stringify(viewData));
                        console.log('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–∏–¥ –∏–∑ markers.json');
                    }

                    updateMarkerCount();
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${markers.length} –º–∞—Ä–∫–µ—Ä–æ–≤ –∏–∑ ${CONFIG.markersFile}`);
                })
                .catch(error => {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å markers.json:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã –∏–∑ —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ markers.json –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.');
                });
        }

        function clearMarkers() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã?')) {
                markers.forEach(m => {
                    if (m.container.parentNode) markerContainer.removeChild(m.container);
                });
                markers = [];
                localStorage.removeItem(CONFIG.storageKey);
                updateMarkerCount();
            }
        }

        function exportMarkers() {
            const markersData = markers.map(m => ({
                id: m.id, theta: m.coords.theta, phi: m.coords.phi, text: m.text,
                fontSize: m.fontSize, fontFamily: m.fontFamily, fontWeight: m.fontWeight, fontStyle: m.fontStyle,
                url: m.url || '', color: m.color || '#ffffff', date: m.date
            }));
            const exportObj = {
                markers: markersData,
                view: { x: sphereRotation.x, y: sphereRotation.y }
            };
            const dataStr = JSON.stringify(exportObj, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'markers_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importMarkers() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const imported = JSON.parse(event.target.result);
                        
                        let markersData = [];
                        let viewData = null;
                        
                        if (Array.isArray(imported)) {
                            markersData = imported;
                        } else if (imported && typeof imported === 'object') {
                            if (Array.isArray(imported.markers)) markersData = imported.markers;
                            if (imported.view && typeof imported.view.x === 'number' && typeof imported.view.y === 'number') {
                                viewData = imported.view;
                            }
                        }
                        
                        markers.forEach(m => {
                            if (m.container.parentNode) markerContainer.removeChild(m.container);
                        });
                        markers = [];
                        
                        markersData.forEach(markerData => {
                            addMarker(
                                { theta: markerData.theta, phi: markerData.phi },
                                markerData.text,
                                markerData.id,
                                markerData.fontSize || 14,
                                markerData.fontFamily || 'Arial, sans-serif',
                                markerData.fontWeight || 'normal',
                                markerData.fontStyle || 'normal',
                                markerData.url || '',
                                markerData.color || '#ffffff'
                            );
                        });
                        
                        if (viewData) {
                            sphereRotation.x = viewData.x;
                            sphereRotation.y = viewData.y;
                            sphereRotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, sphereRotation.x));
                            if (sphere) {
                                sphere.rotation.y = sphereRotation.y;
                                sphere.rotation.x = sphereRotation.x;
                            }
                            localStorage.setItem(CONFIG.viewStorageKey, JSON.stringify(viewData));
                            alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${markersData.length} –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –≤–∏–¥`);
                        } else {
                            alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${markersData.length} –º–∞—Ä–∫–µ—Ä–æ–≤`);
                        }
                        
                        updateMarkerCount();
                        saveMarkers();
                    } catch(error) {
                        alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        function initEventHandlers() {
            renderer.domElement.addEventListener('dblclick', (event) => {
                if (!sphere) { alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–∞–Ω–æ—Ä–∞–º—É!'); return; }
                const coords = getSphericalCoords(event);
                if (coords) {
                    pendingMarkerCoords = coords;
                    showMarkerDialog('', '#ffffff');
                }
            });
            // –£–¥–∞–ª—è–µ–º orientationchange, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ resize
            renderer.domElement.addEventListener('contextmenu', (e) => e.preventDefault());
            document.getElementById('file-input').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file || !file.type.match('image.*')) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'); return; }
                try {
                    await loadPanoramaFromFile(file);
                    initControls();
                    loadMarkers();
                    loadInitialView();
                    animate();
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('manual-upload').classList.remove('hidden');
                }
            });
        }

        // ========== –ê–ù–ò–ú–ê–¶–ò–Ø ==========
        function animate() {
            requestAnimationFrame(animate);
            updatePhysics();
            updateMarkerLabels();
            renderer.render(scene, camera);
        }

        function updatePhysics() {
            if (isInertia && !isDragging && !isTouchActive) {
                sphereRotation.y += velocity.x;
                sphereRotation.x += velocity.y;
                sphereRotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, sphereRotation.x));
                if (sphere) { sphere.rotation.y = sphereRotation.y; sphere.rotation.x = sphereRotation.x; }
                velocity.x *= friction; velocity.y *= friction;
                if (Math.abs(velocity.x) < 0.0001 && Math.abs(velocity.y) < 0.0001) { velocity = { x:0, y:0 }; isInertia = false; }
            }
            if (Math.abs(zoomVelocity) > 0.01) {
                fov += zoomVelocity; zoomVelocity *= zoomFriction;
                fov = Math.max(minFov, Math.min(maxFov, fov));
                camera.fov = fov; camera.updateProjectionMatrix();
                
                // –ü—Ä–∏ –∑—É–º–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –¥—Ä–µ–≤–∫–æ–≤
                updateAllPoleHeights();
            }
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        async function init() {
            initThreeJS();
            initEventHandlers();
            window.addEventListener('resize', () => {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–º–µ—Ä—ã
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –≤—ã—Å–æ—Ç—É –¥—Ä–µ–≤–∫–æ–≤
                updateAllPoleHeights();
                updateMarkerLabels();
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –æ–¥–∏–Ω –∫–∞–¥—Ä, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –º–µ—Ä—Ü–∞–Ω–∏—è
                renderer.render(scene, camera);
            });
            try {
                await tryLoadPanorama();
                initControls();
                loadMarkers();
                loadInitialView();
                animate();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥—Ä–µ–≤–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                setTimeout(updateAllPoleHeights, 500);
            } catch (error) { console.log('–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –∂–¥—ë–º —Ä—É—á–Ω—É—é'); }
            
            window.saveMarkers = saveMarkers;
            window.clearMarkers = clearMarkers;
            window.exportMarkers = exportMarkers;
            window.importMarkers = importMarkers;
            window.cancelMarkerDialog = cancelMarkerDialog;
            window.applyMarkerDialog = applyMarkerDialog;
            window.saveCurrentView = saveCurrentView;
            window.resetView = resetView;
            window.exportView = exportView;
            window.importView = importView;
        }

        init();
    </script>
</body>
</html>
